var KPDL=function(){"use strict";const e=new class{constructor(){this.level=0}error(...e){console.log("%c[KPDL]","background:darkred;padding:2px;",...e)}info(...e){this.level>0&&console.log("%c[KPDL]","background:darkgreen;padding:2px;",...e)}debug(...e){this.level>1&&console.log("%c[KPDL]","background:darkblue;padding:2px;",...e)}};function t(e){const t=encodeURIComponent(e)+"=",s=document.cookie.split("; ").find((e=>e.startsWith(t)));return s?decodeURIComponent(s.split(t)[1]):void 0}function s(e,t){return t?localStorage&&localStorage.getItem(e):sessionStorage&&sessionStorage.getItem(e)}async function i(e){try{return e.ok?await e.json():void 0}catch{}}location.host.indexOf("localhost");class n{constructor(t){this.instance=t,e.debug("sw",t),setInterval((()=>{this.keepAlive()}),5e3)}async message(e){return new Promise(((t,s)=>{const i=new MessageChannel;i.port1.onmessage=e=>{e.data.error?s(e.data.error):t(e.data)},this.instance.postMessage(e,[i.port2])}))}async reset(t={all:!0}){return e.info("sw.reset",t),this.message({type:"reset",state:t})}keepAlive(){e.debug("sw.keepAlive"),this.message({type:"wait",delay:4e3})}}async function o(t){if("serviceWorker"in navigator){if(s("kpdl-nosw"))return await async function(){return navigator.serviceWorker.getRegistrations().then((e=>{for(const t of e)t.unregister()}))}(),void e.info("serviceWorker disabled");try{const s=await navigator.serviceWorker.register(t),i=s.installing||s.waiting;if(i)i.addEventListener("statechange",(async()=>{if(s.active&&"activated"===s.active.state)return new n(s.active)}));else{if(navigator.serviceWorker.controller||s.active)return new n(navigator.serviceWorker.controller||s.active);e.error("no serviceWorker controller")}}catch(t){e.error(t)}}else e.error("serviceWorker not in navigator")}function r(e){let t=e;var s={}.toString.call(e).slice(8,-1);if("Set"==s)return new Set([...e].map((e=>r(e))));if("Map"==s)return new Map([...e].map((e=>[r(e[0]),r(e[1])])));if("Date"==s)return new Date(e.getTime());if("Array"==s||"Object"==s)for(var i in t=Array.isArray(e)?[]:{},e)t[i]=r(e[i]);return t}function a(e,t){if(e===t)return!0;if(typeof t!=typeof e)return!1;if("object"!=typeof e||null===e)return e===t;if(e&&!t)return!1;if(Array.isArray(e)){if(e.length!=t.length)return!1;for(let s=0;s<e.length;s++)if((s in e||s in t)&&(s in e!=s in t||!a(e[s],t[s])))return!1;return!0}return e instanceof Date?t instanceof Date&&e.getTime()===t.getTime():Array.from(new Set([...Object.keys(e),...Object.keys(t)])).every((function(s){var i=e[s],n=t[s];return"object"==typeof i&&null!==i&&null!==n?a(i,n):"function"==typeof i?i(n):n===i}))}function c(e){return parseInt(e,10)||0}function l(e,t){const s=/^[A-Za-z]\w*$/,i=(e||"").split(".").slice(0,2);if(t=t&&s.test(t)?t:"_global",i.every((e=>s.test(e))))return 1===i.length&&i.unshift(t),{ns:i[0],key:i[1]}}function d(e,t){const s=new URL(e);return`${s.origin}${s.pathname}${t}${s.hash}${s.search}`.replace(/([^:]\/)\/+/g,"$1")}async function f(e){return new Promise((t=>setTimeout(t,e)))}const p="_persistent";class u{constructor(t,s){this.basePath="/s",this.profile={},this.store={},this.storeUpdates=[],this.config=t,this.config.sessionId=this.config.sessionId||"_current",this.sw=s,e.debug("profile",this.config,!!s)}get info(){return this.config}get all(){return r(this.profile)}get data(){return this.store}async init(){if(this.config.endpoint){this.config.endpoint=this.config.endpoint.replace("/ist/ui-data-layer-bff/","/api/kpd/uidatalayer/"),this.config.secure||"string"!=typeof this.config.endpoint||(this.config.endpoint=this.config.endpoint.replace("/mycare/","/care/"),this.basePath="/ns");const t=d(this.config.endpoint,`${this.basePath}/profile`);e.debug("profile.init",t);const s=await async function(e){return i(await fetch(e,{credentials:"include"}))}(t);if(s){this.profile=s.profile,this.config.sessionId=s.profile?.sessionId||this.config.sessionId,this.store={};for(const e in s.data)e!==p&&e!==this.config.sessionId||(this.store[e]=s.data[e])}}this.profile=this.profile||{},this.store=this.store||{}}async getData(e,t){const s=this.store._persistent,i=this.store[this.config.sessionId],n=i&&i[e]&&i[e][t]||s&&s[e]&&s[e][t];if(n&&!(n.expires&&n.expires<(new Date).valueOf()||n.scope&&n.scope!==location.origin+location.pathname))return r(n.payload)}async setData(t,s,i,n={}){e.debug("profile.setData",t,s,i,n);const{options:o,session:l}=function(e,t){let s;const i={};"page"===e.scope&&(i.scope=location.origin+location.pathname);if(void 0!==e.expires){const t=c(e.expires);s=p,t>0&&(i.expires=t)}else s=t;return{options:i,session:s}}(n,this.config.sessionId);i=r(i),void 0!==o.expires&&o.expires<(new Date).valueOf()&&(i=void 0);let d=!1;this.store[l]=this.store[l]||{};const f=this.store[l];if(void 0===s)f[t]&&(d=!0),delete f[t];else if(void 0===i)f[t]&&f[t][s]&&(d=!0),f[t]&&delete f[t][s],f[t]&&!Object.keys(f[t]).length&&delete f[t];else{f[t]=f[t]||{};const e=Object.assign({payload:i},o);d=!a(f[t][s],e),f[t][s]=e}if(this.sw&&await this.sw.message({type:"patch",path:"_netcache.uidl[0].body.data",key:l,value:f}),this.config.endpoint&&d&&!1!==n.persist){const r=this.storeUpdates.find((e=>e.session===l&&e.ns===t&&e.key===s));r?(e.debug("profile.setData:update",i,n),r.payload=i,r.opts=o):(e.debug("profile.setData:insert",i,n),this.storeUpdates.push({session:l,ns:t,key:s,payload:i,opts:o}))}}async flushUpdates(t){if(e.debug("profile.flushUpdates",t,this.storeUpdates.length),this.config.endpoint&&this.storeUpdates.length){const e=d(this.config.endpoint,`${this.basePath}/data`);await async function(e,t,s){return i(await fetch(e,{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:s}))}(e,this.storeUpdates,t),this.storeUpdates.length=0}}}const g=function(){let e,t;return{promise:new Promise(((s,i)=>{e=s,t=i})),resolve:e,reject:t}}(),h="/kpdl.sw.js",y="jsonConfigs"in window&&jsonConfigs.global&&jsonConfigs.global.uidlBFFUrl;let v,w,m;e.level=c(s("kpdl-debug"));const k=async(t,s)=>{const i=/isSignedOn=true/.test(document.cookie);e.info("initialize",i?"(secure)":""),w=await o(h),w&&await w.message({type:"init",visitorId:t,sessionId:s,secure:i}),m=await async function(e,t){const s=new u(e,t);return await s.init(),s}({visitorId:t,sessionId:s,endpoint:y,secure:i},w),document.addEventListener("visibilitychange",(()=>{m&&"hidden"===document.visibilityState&&m.flushUpdates(!0)})),v&&clearInterval(v),v=setInterval((()=>{m&&m.flushUpdates(!0)}),45e3),g.resolve(),e.info("ready")};return window&&window.KPDL||new class{constructor(){(async(s=0)=>{let i;for(let n=0;n<s&&(n&&await f(500),i=t("kp-visitor-id"),!i);n++)e.info("Cookie information not found. Retry in 500ms");k(i)})(5)}get info(){return Object.assign({version:"2.2.10",swPath:h,swActive:!!w},m?.info)}get ready(){return g.promise}get profile(){return m?.all}get targetData(){return function(e){if(e.data&&delete e.data,e&&e.segments){for(const t of e.segments)e[`seg.${t}`]=!0;delete e.segments}return e}(this.profile)}async setData(e,t,s={}){await this.ready;const i=l(e,s.ns);return i&&m.setData(i.ns,i.key,t,s)}async getData(e,t){await this.ready;const s=l(e,t);return s&&m.getData(s.ns,s.key)}async purgeData(e){return await this.ready,e&&m.setData(e,void 0,void 0)}async _raw(e){return w?w.message({type:"raw",path:e}).then((({payload:e})=>e)):Promise.resolve()}async reset(){return w?w.reset():Promise.resolve()}}}();
